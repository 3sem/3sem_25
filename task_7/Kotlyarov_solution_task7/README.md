# IO Server Project

Проект представляет собой клиент-серверную систему для передачи файлов с использованием именованных каналов (FIFO) и многопоточности.

## Структура проекта

```
task7-ioserver/
├── CMakeLists.txt          # Конфигурация сборки CMake
├── headers/                # Заголовочные файлы
│   ├── client_funcs.h
│   ├── client_server_cfg.h
│   ├── Debug_printf.h
│   ├── fifo_utils.h
│   ├── server_funcs.h
│   └── thread_utils.h
├── src/                    # Исходные файлы
│   ├── client.c            # Основной файл клиента
│   ├── client_funcs.c      # Функции клиента
│   ├── fifo_utils.c        # Утилиты для работы с FIFO
│   ├── server.c            # Основной файл сервера
│   ├── server_funcs.c      # Функции сервера
│   └── thread_utils.c      # Управление потоками
├── libs/                   # Вспомогательные библиотеки
│   └── Check_flags/
│       ├── Check_r_w_flags.c
│       └── Check_r_w_flags.h
└── tests/                  # Тесты
    ├── test_multiple_clients.c  # Тест множественных клиентов
    └── run_test.sh         # Скрипт запуска тестов
```

## Функциональность

### Сервер
- Создает главный FIFO для регистрации клиентов
- Использует epoll для асинхронной обработки соединений
- Реализует пул потоков для параллельной обработки запросов
- Поддерживает graceful shutdown при получении сигналов (Ctrl+C)
- Автоматически очищает ресурсы при завершении

### Клиент
- Регистрируется на сервере через главный FIFO
- Создает собственные FIFO для двусторонней связи
- Отправляет запросы на получение файлов
- Поддерживает перенаправление вывода в файл
- Корректно очищает ресурсы при завершении

## Сборка проекта

### Инструкция по сборке

```bash
# Создание директории для сборки
mkdir build
cd build

# Конфигурация проекта
cmake ..

# Сборка всех компонентов
make

# Сборка и запуск тестов
make run_test
```

```bash
# Альтернативный вариант сборки в режиме Debug
cd build
cmake -DCMAKE_BUILD_TYPE=Debug ..
make
```

После сборки исполняемые файлы будут созданы в `build/bin/`:
- `client` - клиентская программа
- `server` - серверная программа
- `test_multiple_clients` - тестовая программа (в корне `build/`)

## Запуск

### Запуск сервера

```bash
# Из папки build
./bin/server
```

Сервер запускается в фоновом режиме и создает FIFO `Client_server_fifo` для приема регистрационных запросов.

### Запуск клиента

```bash
# Базовая форма
./bin/client -r <filename> [ -r <filename2> ... ] [ -w <output_file> ]

# Примеры использования
./bin/client -r file1.txt                    # Запросить один файл
./bin/client -r file1.txt -r file2.txt       # Запросить несколько файлов
./bin/client -r file1.txt -w output.txt      # Запросить файл и сохранить в output.txt
./bin/client -h                              # Показать справку
```

### Опции клиента

`-r, --read <filename>` - запросить файл с сервера (можно указать несколько раз)

`-w, --write <filename>` - перенаправить вывод в указанный файл

`-h, --help` - показать справку по использованию

## Тестирование

### Запуск стресс-теста

```bash
# Из папки build
make run_test
```

Этот тест:
- Запускает сервер в отдельном процессе
- Создает 10 клиентов, каждый из которых запрашивает 5 файлов
- Автоматически создает и удаляет тестовые файлы
- Проверяет корректность работы системы под нагрузкой

### Ручное тестирование

```bash
# Терминал 1 - Запуск сервера
./bin/server

# Терминал 2 - Запуск клиента
./bin/client -r test_file.txt -w output.txt
```

## Архитектура

### Связь между процессами

```
Клиент 1 ──┐
           ├─── Client_server_fifo (регистрация) ──── Сервер ──── Пул потоков
Клиент 2 ──┘
    │
    ├── fifos/client_<PID>/tx  (клиент читает, сервер пишет)
    └── fifos/client_<PID>/rx  (клиент пишет, сервер читает)
```

### Протокол взаимодействия

1. **Регистрация клиента**:
   - Клиент отправляет: `REGISTER <tx_path> <rx_path>`
   - Сервер отвечает: `ACK`

2. **Запрос файла**:
   - Клиент отправляет: `GET <filename>`
   - Сервер передает содержимое файла через tx_fd

## Особенности реализации

- Использование non-blocking I/O с epoll для эффективной обработки множества клиентов
- Пул из 4 рабочих потоков для параллельной обработки запросов
- Graceful shutdown с корректной очисткой всех ресурсов
- Автоматическое создание и удаление FIFO
- Обработка ошибок и таймаутов

## Отладка

Для отладки можно использовать режим Debug сборки:

```bash
cd build
cmake -DCMAKE_BUILD_TYPE=Debug ..
make
```

В этом режиме включается:
- Подробное логирование через `Debug_printf.h`
- Санитайзеры AddressSanitizer и UndefinedBehaviorSanitizer
- Отладочная информация (`-g` flag)
- Отключение оптимизаций (`-O0`)

## Устранение неполадок

### Ошибки выполнения
- Сервер должен быть запущен до клиентов
- Убедитесь, что нет других запущенных экземпляров сервера
- Проверьте права доступа к FIFO файлам
- Используйте `make run_test` для автоматического тестирования всей системы
